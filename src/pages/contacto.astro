---
import Layout from '../layouts/Layout.astro';
const WEB_APP_URL = import.meta.env.PUBLIC_WEB_APP_URL; // se resuelve en build/SSR
---

<Layout>
  <h1 class="text-3xl mb-6">Contacto</h1>

  <form id="contactForm" data-endpoint={WEB_APP_URL} class="grid gap-3 max-w-lg">
    <input name="nombre"  placeholder="Nombre completo" class="border p-2 rounded" required />
    <input name="email"   type="email" placeholder="Correo" class="border p-2 rounded" required />
    <select name="tipo" class="border p-2 rounded" required>
      <option value="" selected disabled>Selecciona un servicio</option>
      <option>Landing OnePage</option>
      <option>Sitio Estático Local</option>
      <option>Mejora CSS/Responsive</option>
      <option>Catálogo Digital</option>
      <option>Formularios Conectados</option>
    </select>
    <textarea name="mensaje" placeholder="Mensaje" class="border p-2 rounded" required></textarea>

    <label class="flex items-center gap-2 text-sm">
      <input id="policy" type="checkbox" required />
      Acepto la política de privacidad
    </label>

    <button id="submitBtn" type="submit"
      class="px-4 py-2 rounded bg-cyan-600 text-white disabled:opacity-50 disabled:cursor-not-allowed">
      Enviar Mensaje
    </button>
    <p id="status" class="text-sm"></p>
  </form>

  <script type="module">
    const form = document.getElementById('contactForm');
    const WEB_APP_URL = form.dataset.endpoint;           // ← tomado del HTML
    const btn = document.getElementById('submitBtn');
    const policy = document.getElementById('policy');
    const statusEl = document.getElementById('status');

    function updateBtn(){ btn.disabled = !(form.checkValidity() && policy.checked); }
    form.addEventListener('input', updateBtn);
    form.addEventListener('change', updateBtn);
    updateBtn();

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!form.checkValidity()) return;

      btn.disabled = true;
      statusEl.textContent = 'Enviando...';
      const data = Object.fromEntries(new FormData(form).entries());

      try {
        await fetch(WEB_APP_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(data)
        });
        statusEl.textContent = 'Enviado ✔';
        form.reset();
      } catch {
        statusEl.textContent = 'Error de red';
      } finally {
        updateBtn();
      }
    });
  </script>
</Layout>